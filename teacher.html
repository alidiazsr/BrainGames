<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Profesor - BrainGames</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2563eb;
            font-size: 2em;
        }

        .room-code {
            background: #f0f4fa;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            color: #2563eb;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .left-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .right-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            color: #2563eb;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #2563eb;
            background: #f8faff;
        }

        .file-upload.dragover {
            border-color: #2563eb;
            background: #f0f4fa;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .quiz-info {
            background: #f0f4fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #2563eb;
        }

        .students-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            animation: slideInRight 0.5s ease-out;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }

        .student-name {
            flex: 1;
            font-weight: 500;
        }

        .student-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .question-display {
            background: #f8faff;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #e5e7eb;
        }

        .question-display.active {
            border-color: #2563eb;
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.2);
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #ef4444;
            text-align: center;
            margin: 20px 0;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .option {
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: #2563eb;
            background: #f0f4fa;
        }

        .option.correct {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .ranking {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            background: #f8faff;
        }

        .ranking-position {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2563eb;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .ranking-position.gold {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
        }

        .ranking-position.silver {
            background: linear-gradient(45deg, #c0c0c0, #e5e5e5);
            color: #333;
        }

        .ranking-position.bronze {
            background: linear-gradient(45deg, #cd7f32, #d4a574);
            color: white;
        }

        .hidden {
            display: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Panel del Profesor</h1>
            <div class="room-code">
                C√≥digo de Sala: <span id="roomCode">------</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Panel Principal -->
            <div class="left-panel">
                <!-- Secci√≥n de carga de cuestionario -->
                <div id="uploadSection" class="section">
                    <h3>üìã Cargar Cuestionario</h3>
                    <div class="file-upload" id="fileUpload">
                        <p>üìÅ Arrastra aqu√≠ tu archivo JSON o haz clic para seleccionar</p>
                        <input type="file" id="fileInput" accept=".json" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            Seleccionar Archivo
                        </button>
                    </div>
                    
                    <div id="quizInfo" class="quiz-info hidden">
                        <h4 id="quizTitle"></h4>
                        <p id="quizDescription"></p>
                        <p><strong>Preguntas:</strong> <span id="questionCount"></span></p>
                        <div class="controls">
                            <button class="btn btn-success" onclick="openRoom()">üöÄ Abrir Sala</button>
                            <button class="btn btn-warning" onclick="loadDemoQuiz()">üìñ Cargar Demo</button>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n de control del juego -->
                <div id="gameSection" class="section hidden">
                    <h3>üéÆ Control del Juego</h3>
                    
                    <!-- Vista de pregunta actual -->
                    <div id="questionDisplay" class="question-display">
                        <h4 id="currentQuestion"></h4>
                        <div id="currentOptions" class="options-grid"></div>
                        <div id="timer" class="timer">00</div>
                        <div class="controls">
                            <button id="startQuestionBtn" class="btn btn-success" onclick="startQuestion()">‚ñ∂Ô∏è Iniciar Pregunta</button>
                            <button id="nextQuestionBtn" class="btn btn-primary hidden" onclick="nextQuestion()">‚û°Ô∏è Siguiente</button>
                            <button id="showResultsBtn" class="btn btn-warning hidden" onclick="showFinalResults()">üèÜ Resultados Finales</button>
                        </div>
                    </div>

                    <!-- Ranking temporal -->
                    <div id="rankingSection" class="hidden">
                        <h4>üìä Ranking de la Pregunta</h4>
                        <div id="questionRanking"></div>
                        <div id="explanation" style="background: #f0f4fa; padding: 15px; border-radius: 10px; margin-top: 15px;"></div>
                    </div>
                </div>

                <!-- Resultados finales -->
                <div id="finalResults" class="section hidden">
                    <h3>üèÜ Resultados Finales</h3>
                    <div id="podium" class="ranking"></div>
                    <div class="controls">
                        <button class="btn btn-primary" onclick="restartGame()">üîÑ Nuevo Juego</button>
                        <button class="btn btn-danger" onclick="closeRoom()">‚ùå Cerrar Sala</button>
                    </div>
                </div>
            </div>

            <!-- Panel de Estudiantes -->
            <div class="right-panel">
                <div class="section">
                    <h3>üë• Estudiantes Conectados (<span id="studentCount">0</span>)</h3>
                    <div id="studentsList" class="students-list">
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Esperando estudiantes...
                        </p>
                    </div>
                    
                    <div id="gameControls" class="hidden" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="startGame()" style="width: 100%;">
                            üéØ Comenzar Cuestionario
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Configuraci√≥n de Firebase (debes reemplazar con tu configuraci√≥n real)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, serverTimestamp, remove, off } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js';

        // CONFIGURACI√ìN REAL DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD98M3qkOioDzwBHMTNc2nQoWkudoBC1RY",
            authDomain: "braingamesquiz.firebaseapp.com",
            databaseURL: "https://braingamesquiz-default-rtdb.firebaseio.com",
            projectId: "braingamesquiz",
            storageBucket: "braingamesquiz.firebasestorage.app",
            messagingSenderId: "127450849239",
            appId: "1:127450849239:web:9749f4d3fbe51c6f907592"
        };

        // Variables globales del juego
        let app = null;
        let database = null;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let roomCode = null;
        let students = {};
        let roomRef = null;
        let studentsRef = null;

        // Sistema de control de juego
        let gameController = {
            state: 'WAITING',           // WAITING, GAME_READY, QUESTION_ACTIVE, QUESTION_ENDED, GAME_FINISHED
            timer: null,
            timeLeft: 0,
            questionStartTime: null,
            
            // Estados v√°lidos
            STATES: {
                WAITING: 'WAITING',
                GAME_READY: 'GAME_READY', 
                QUESTION_ACTIVE: 'QUESTION_ACTIVE',
                QUESTION_ENDED: 'QUESTION_ENDED',
                GAME_FINISHED: 'GAME_FINISHED'
            },

            // Cambiar estado de forma segura
            setState: function(newState) {
                console.log(`üéÆ Estado: ${this.state} ‚Üí ${newState}`);
                this.state = newState;
                this.updateUI();
            },

            // Limpiar temporizador
            clearTimer: function() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                    console.log('‚è±Ô∏è Temporizador limpiado');
                }
            },

            // Actualizar interfaz seg√∫n estado
            updateUI: function() {
                const startGameBtn = document.getElementById('gameControls');
                const startQuestionBtn = document.getElementById('startQuestionBtn');
                const nextBtn = document.getElementById('nextQuestionBtn');
                const finishBtn = document.getElementById('showResultsBtn');
                const rankingSection = document.getElementById('rankingSection');

                // Ocultar todo primero
                if (startGameBtn) startGameBtn.classList.add('hidden');
                if (startQuestionBtn) startQuestionBtn.classList.add('hidden');
                if (nextBtn) nextBtn.classList.add('hidden'); 
                if (finishBtn) finishBtn.classList.add('hidden');
                if (rankingSection) rankingSection.classList.add('hidden');

                // Mostrar seg√∫n estado
                switch(this.state) {
                    case this.STATES.WAITING:
                        if (Object.keys(students).length > 0 && currentQuiz) {
                            startGameBtn?.classList.remove('hidden');
                        }
                        break;
                    case this.STATES.GAME_READY:
                        startQuestionBtn?.classList.remove('hidden');
                        break;
                    case this.STATES.QUESTION_ENDED:
                        rankingSection?.classList.remove('hidden');
                        if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                            nextBtn?.classList.remove('hidden');
                        } else {
                            finishBtn?.classList.remove('hidden');
                        }
                        break;
                }
            },

            // Verificar si se puede ejecutar una acci√≥n
            canExecute: function(action) {
                const validTransitions = {
                    'START_GAME': [this.STATES.WAITING],
                    'START_QUESTION': [this.STATES.GAME_READY],
                    'END_QUESTION': [this.STATES.QUESTION_ACTIVE],
                    'NEXT_QUESTION': [this.STATES.QUESTION_ENDED],
                    'FINISH_GAME': [this.STATES.QUESTION_ENDED]
                };

                return validTransitions[action]?.includes(this.state);
            }
        };

        // Inicializar Firebase y comunicaci√≥n
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                console.log('‚úÖ Firebase inicializado correctamente');
                return true;
            } catch (error) {
                console.log('‚ùå Error de Firebase, usando simulaci√≥n local:', error);
                return false;
            }
        }

        // Crear sala en Firebase
        function createRoomInFirebase() {
            if (!database) return;
            
            roomRef = ref(database, `rooms/${roomCode}`);
            studentsRef = ref(database, `rooms/${roomCode}/students`);
            
            // Crear la sala
            set(roomRef, {
                quiz: currentQuiz,
                currentQuestion: 0,
                gameState: 'waiting',
                createdAt: serverTimestamp(),
                teacher: 'profesor'
            });

            // Escuchar estudiantes que se unen (con protecci√≥n contra interferencias)
            onValue(studentsRef, (snapshot) => {
                const studentsData = snapshot.val();
                console.log('üì° Estudiantes actualizados:', studentsData);
                
                // Verificar que no interfiera con preguntas en curso
                if (gameState === 'question' && questionTimer) {
                    console.log('üîí Pregunta en curso - Actualizando solo datos internos');
                }
                
                if (studentsData) {
                    updateStudentsList(studentsData);
                } else {
                    // Solo resetear si no hay pregunta en curso
                    if (gameState !== 'question') {
                        resetStudentsList();
                    }
                }
            });

            console.log(`üöÄ Sala ${roomCode} creada en Firebase`);
        }

        // Actualizar lista de estudiantes en la interfaz
        function updateStudentsList(studentsData) {
            // Si hay una pregunta en curso, no actualizar la interfaz para no interrumpir
            if (gameState === 'question' && questionTimer) {
                // Solo actualizar los datos internos, no la interfaz visual
                students = studentsData;
                console.log('üìä Datos de estudiantes actualizados (pregunta en curso)');
                return;
            }
            
            const studentsList = document.getElementById('studentsList');
            studentsList.innerHTML = '';
            
            students = studentsData;
            const studentCount = Object.keys(students).length;
            
            Object.keys(students).forEach(studentId => {
                const student = students[studentId];
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';
                studentItem.innerHTML = `
                    <div class="student-avatar">${student.avatar}</div>
                    <div class="student-name">${student.name}</div>
                    <div class="student-status"></div>
                `;
                studentsList.appendChild(studentItem);
            });
            
            document.getElementById('studentCount').textContent = studentCount;
            
            // Solo mostrar controles si no hay pregunta en curso
            if (gameState !== 'question') {
                if (studentCount > 0 && currentQuiz) {
                    document.getElementById('gameControls').classList.remove('hidden');
                } else {
                    document.getElementById('gameControls').classList.add('hidden');
                }
            }
        }

        // Resetear lista de estudiantes
        function resetStudentsList() {
            const studentsList = document.getElementById('studentsList');
            studentsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Esperando estudiantes...</p>';
            document.getElementById('studentCount').textContent = '0';
            document.getElementById('gameControls').classList.add('hidden');
            students = {};
        }

        // Enviar actualizaci√≥n de estado del juego
        function updateGameState(newState, data = {}) {
            if (!database || !roomRef) return;
            
            const updateData = {
                gameState: newState,
                currentQuestion: currentQuestionIndex,
                lastUpdate: serverTimestamp(),
                ...data
            };
            
            set(ref(database, `rooms/${roomCode}/gameData`), updateData);
            console.log(`üì° Estado del juego actualizado: ${newState}`);
        }

        // Funciones principales
        window.loadDemoQuiz = function() {
            const demoQuiz = {
                title: "JavaScript B√°sico",
                description: "Cuestionario de conceptos fundamentales de JavaScript",
                questions: [
                    {
                        id: 1,
                        question: "¬øCu√°l es la forma correcta de declarar una variable en JavaScript?",
                        options: [
                            "variable miVariable = 'hola';",
                            "var miVariable = 'hola';",
                            "declare miVariable = 'hola';",
                            "set miVariable = 'hola';"
                        ],
                        correct: 1,
                        explanation: "La palabra clave 'var' es una de las formas correctas de declarar variables en JavaScript, junto con 'let' y 'const'.",
                        timeLimit: 20
                    },
                    {
                        id: 2,
                        question: "¬øQu√© tipo de datos NO existe en JavaScript?",
                        options: [
                            "String",
                            "Boolean",
                            "Integer",
                            "Undefined"
                        ],
                        correct: 2,
                        explanation: "JavaScript no tiene un tipo 'Integer' espec√≠fico. Los n√∫meros se manejan como 'Number', que incluye tanto enteros como decimales.",
                        timeLimit: 25
                    },
                    {
                        id: 3,
                        question: "¬øCu√°l es el resultado de: console.log(typeof null)?",
                        options: [
                            "null",
                            "undefined",
                            "object",
                            "boolean"
                        ],
                        correct: 2,
                        explanation: "Esta es una peculiaridad hist√≥rica de JavaScript. typeof null devuelve 'object', aunque null no es realmente un objeto.",
                        timeLimit: 30
                    }
                ]
            };
            
            loadQuiz(demoQuiz);
        };

        function loadQuiz(quiz) {
            currentQuiz = quiz;
            document.getElementById('quizTitle').textContent = quiz.title;
            document.getElementById('quizDescription').textContent = quiz.description;
            document.getElementById('questionCount').textContent = quiz.questions.length;
            document.getElementById('quizInfo').classList.remove('hidden');
        }

        window.openRoom = function() {
            if (!currentQuiz) return;
            
            roomCode = generateRoomCode();
            document.getElementById('roomCode').textContent = roomCode;
            
            // Inicializar Firebase
            const firebaseReady = initializeFirebase();
            
            // Ocultar secci√≥n de carga y mostrar secci√≥n de juego
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
            
            // Mostrar primera pregunta
            showQuestion(0);
            
            if (firebaseReady) {
                // Crear sala en Firebase
                createRoomInFirebase();
            } else {
                // Modo sin Firebase - solo mostrar mensaje
                console.log('‚ö†Ô∏è Funcionando en modo local - configura Firebase para sincronizaci√≥n real');
                alert('‚ö†Ô∏è Modo local activo\n\nPara sincronizaci√≥n real entre PCs, configura Firebase seg√∫n el README.md');
            }
            
            console.log(`Sala creada con c√≥digo: ${roomCode}`);
        };

        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function showQuestion(index) {
            if (!currentQuiz || index >= currentQuiz.questions.length) return;
            
            // Limpiar cualquier temporizador anterior
            if (questionTimer) {
                clearInterval(questionTimer);
                questionTimer = null;
            }
            
            const question = currentQuiz.questions[index];
            currentQuestionIndex = index;
            
            // Restablecer estado visual
            document.getElementById('timer').style.color = '#2563eb';
            document.getElementById('timer').textContent = question.timeLimit;
            
            document.getElementById('currentQuestion').textContent = 
                `Pregunta ${index + 1}: ${question.question}`;
            
            const optionsContainer = document.getElementById('currentOptions');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, i) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = `${String.fromCharCode(65 + i)}) ${option}`;
                if (i === question.correct) {
                    optionDiv.classList.add('correct');
                }
                optionsContainer.appendChild(optionDiv);
            });
        }

        window.startQuestion = function() {
            console.log('‚ùì Intentando iniciar pregunta...');
            
            if (!gameController.canExecute('START_QUESTION')) {
                alert(`‚ùå No se puede iniciar pregunta en estado: ${gameController.state}`);
                return;
            }

            if (!currentQuiz) {
                alert('‚ùå No hay cuestionario cargado');
                return;
            }

            if (currentQuestionIndex >= currentQuiz.questions.length) {
                endQuiz();
                return;
            }

            // Verificar estudiantes conectados
            if (Object.keys(students).length === 0) {
                alert('‚ö†Ô∏è No hay estudiantes conectados\n\nEspera a que se conecten estudiantes antes de iniciar la pregunta.');
                return;
            }

            // Limpiar cualquier timer existente de forma segura
            gameController.clearTimer();

            const question = currentQuiz.questions[currentQuestionIndex];
            const timeLimit = question.timeLimit || 30;
            questionStartTime = Date.now();
            studentAnswers = {};

            console.log(`üöÄ Iniciando pregunta ${currentQuestionIndex + 1}: ${question.question}`);

            // Cambiar estado de forma controlada
            gameController.setState(gameController.STATES.QUESTION_ACTIVE);

            // Notificar a estudiantes
            updateGameState('question_started', {
                question: question,
                questionIndex: currentQuestionIndex,
                startTime: questionStartTime
            });

            // Actualizar UI del profesor
            gameController.updateUI();

            // Iniciar timer de forma controlada
            let timeLeft = timeLimit;
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('timer').style.color = '#ef4444';

            gameController.questionTimer = setInterval(() => {
                // Verificar estado antes de continuar
                if (gameController.state !== gameController.STATES.QUESTION_ACTIVE) {
                    console.log('‚ö†Ô∏è Timer auto-detenido - estado cambi√≥ a:', gameController.state);
                    gameController.clearTimer();
                    return;
                }

                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;

                console.log(`‚è∞ Tiempo restante: ${timeLeft}s`);

                if (timeLeft <= 0) {
                    console.log('‚è∞ Tiempo agotado para pregunta');
                    endQuestion();
                }
            }, 1000);

            console.log(`‚úÖ Pregunta ${currentQuestionIndex + 1} iniciada correctamente`);
        };

        function endQuestion() {
            console.log('üõë Terminando pregunta...');
            
            if (!gameController.canExecute('END_QUESTION')) {
                console.log('‚ö†Ô∏è No se puede terminar pregunta en estado:', gameController.state);
                return;
            }

            // Limpiar temporizador de forma controlada
            gameController.clearTimer();
            
            // Cambiar estado de forma controlada
            gameController.setState(gameController.STATES.QUESTION_ENDED);
            
            // Actualizar UI
            gameController.updateUI();
            document.getElementById('timer').style.color = '#6b7280';
            document.getElementById('timer').textContent = '‚èπÔ∏è';
            
            console.log(`‚úÖ Pregunta ${currentQuestionIndex + 1} terminada correctamente`);
            
            // Notificar a estudiantes
            updateGameState('question_ended', {
                correctAnswer: currentQuiz.questions[currentQuestionIndex].correct,
                explanation: currentQuiz.questions[currentQuestionIndex].explanation
            });
            
            // Mostrar ranking de la pregunta
            showQuestionRanking();
            
            // Mostrar explicaci√≥n
            const question = currentQuiz.questions[currentQuestionIndex];
            document.getElementById('explanation').innerHTML = 
                `<strong>‚úÖ Respuesta correcta:</strong> ${question.options[question.correct]}<br>
                 <strong>üí° Explicaci√≥n:</strong> ${question.explanation}`;
            
            document.getElementById('rankingSection').classList.remove('hidden');
            
            // Mostrar bot√≥n siguiente o finalizar
            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                document.getElementById('nextQuestionBtn').classList.remove('hidden');
            } else {
                document.getElementById('showResultsBtn').classList.remove('hidden');
            }
            
            gameState = 'results';
        }

        function showQuestionRanking() {
            const ranking = document.getElementById('questionRanking');
            ranking.innerHTML = '';
            
            // Convertir respuestas de estudiantes reales a array para ranking
            const studentAnswers = [];
            Object.keys(students).forEach(studentName => {
                const student = students[studentName];
                const answer = student.currentAnswer || null;
                const time = student.answerTime || 0;
                
                studentAnswers.push({
                    name: studentName,
                    answer: answer,
                    time: time,
                    avatar: student.avatar
                });
            });
            
            // Si no hay estudiantes conectados, mostrar mensaje
            if (studentAnswers.length === 0) {
                ranking.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay estudiantes conectados a√∫n.</p>';
                return;
            }
            
            // Ordenar por respuesta correcta y luego por tiempo
            studentAnswers.sort((a, b) => {
                const correctAnswer = currentQuiz.questions[currentQuestionIndex].correct;
                const aCorrect = a.answer === correctAnswer;
                const bCorrect = b.answer === correctAnswer;
                
                if (aCorrect && !bCorrect) return -1;
                if (!aCorrect && bCorrect) return 1;
                if (aCorrect && bCorrect) return a.time - b.time;
                return 0;
            });
            
            studentAnswers.forEach((student, index) => {
                const item = document.createElement('div');
                item.className = 'ranking-item';
                
                const correctAnswer = currentQuiz.questions[currentQuestionIndex].correct;
                const isCorrect = student.answer === correctAnswer;
                const points = isCorrect ? Math.max(100 - Math.floor(student.time / 100), 20) : 0;
                
                item.innerHTML = `
                    <div class="ranking-position">${index + 1}</div>
                    <div class="student-avatar">${student.avatar}</div>
                    <div class="student-name">
                        ${student.name}
                        <br><small>${isCorrect ? '‚úÖ' : '‚ùå'} ${points} puntos</small>
                    </div>
                `;
                
                ranking.appendChild(item);
            });
        }

        window.nextQuestion = function() {
            console.log('‚û°Ô∏è Avanzando a siguiente pregunta...');
            
            if (!gameController.canExecute('NEXT_QUESTION')) {
                alert(`‚ùå No se puede avanzar en estado: ${gameController.state}`);
                return;
            }

            // Limpiar cualquier temporizador residual de forma segura
            gameController.clearTimer();
            
            // Restablecer datos de la pregunta anterior
            studentAnswers = {};
            
            // Avanzar a la siguiente pregunta
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= currentQuiz.questions.length) {
                endQuiz();
                return;
            }

            // Cambiar estado de forma controlada
            gameController.setState(gameController.STATES.WAITING_FOR_QUESTION);
            
            // Actualizar UI
            gameController.updateUI();
            showQuestion(currentQuestionIndex);
            
            // Notificar nueva pregunta a estudiantes
            updateGameState('next_question', {
                questionIndex: currentQuestionIndex,
                question: currentQuiz.questions[currentQuestionIndex]
            });

            console.log(`‚úÖ Avanzado a pregunta ${currentQuestionIndex + 1} de ${currentQuiz.questions.length}`);
            
            console.log(`‚û°Ô∏è Preparando pregunta ${currentQuestionIndex + 1}`);
        };

        window.showFinalResults = function() {
            document.getElementById('gameSection').classList.add('hidden');
            document.getElementById('finalResults').classList.remove('hidden');
            
            // Notificar resultados finales a estudiantes
            updateGameState('game_finished');
            
            showPodium();
        };

        function showPodium() {
            const podium = document.getElementById('podium');
            podium.innerHTML = '<h4>üèÜ ¬°Felicitaciones a todas las participantes!</h4>';
            
            // Calcular resultados finales de estudiantes reales
            const finalResults = [];
            Object.keys(students).forEach(studentName => {
                const student = students[studentName];
                const totalPoints = student.totalScore || 0;
                
                finalResults.push({
                    name: studentName,
                    totalPoints: totalPoints,
                    avatar: student.avatar
                });
            });
            
            // Si no hay estudiantes conectados, mostrar mensaje
            if (finalResults.length === 0) {
                podium.innerHTML = '<h4>üèÜ No hay estudiantes conectados</h4><p style="text-align: center; color: #666; padding: 20px;">Espera a que los estudiantes se conecten para ver los resultados.</p>';
                return;
            }
            
            // Ordenar por puntos totales
            finalResults.sort((a, b) => b.totalPoints - a.totalPoints);
            
            finalResults.forEach((student, index) => {
                const item = document.createElement('div');
                item.className = 'ranking-item';
                
                let positionClass = '';
                let emoji = '';
                if (index === 0) { positionClass = 'gold'; emoji = 'ü•á'; }
                else if (index === 1) { positionClass = 'silver'; emoji = 'ü•à'; }
                else if (index === 2) { positionClass = 'bronze'; emoji = 'ü•â'; }
                
                item.innerHTML = `
                    <div class="ranking-position ${positionClass}">${emoji || (index + 1)}</div>
                    <div class="student-avatar">${student.avatar}</div>
                    <div class="student-name">
                        ${student.name}
                        <br><small>üíØ ${student.totalPoints} puntos totales</small>
                    </div>
                `;
                
                podium.appendChild(item);
            });
        }

        // Funci√≥n para terminar el cuestionario
        function endQuiz() {
            console.log('üèÅ Terminando cuestionario completo...');
            
            // Limpiar cualquier timer de forma segura
            gameController.clearTimer();
            
            // Cambiar estado de forma controlada
            gameController.setState(gameController.STATES.GAME_FINISHED);
            
            // Mostrar resultados finales
            showFinalResults();
            
            console.log('üèÜ Cuestionario terminado - Mostrando resultados finales');
        }

        // ===== FUNCIONES PRINCIPALES DEL JUEGO =====
        
        window.startGame = function() {
            console.log('üéÆ Intentando iniciar juego...');
            
            if (!gameController.canExecute('START_GAME')) {
                alert(`‚ùå No se puede iniciar el juego en estado: ${gameController.state}`);
                return;
            }

            if (Object.keys(students).length === 0) {
                alert('‚ö†Ô∏è No hay estudiantes conectados\n\nEspera a que se conecten estudiantes antes de iniciar.');
                return;
            }

            if (!currentQuiz) {
                alert('‚ùå No hay cuestionario cargado');
                return;
            }

            // Cambiar estado de forma controlada
            gameController.setState(gameController.STATES.GAME_READY);
            
            // Notificar a estudiantes
            updateGameState('game_started', {
                totalQuestions: currentQuiz.questions.length,
                message: 'El cuestionario ha comenzado'
            });

            console.log(`‚úÖ Juego iniciado con ${Object.keys(students).length} estudiantes`);
        };

        window.restartGame = function() {
            currentQuestionIndex = 0;
            studentAnswers = {};
            gameState = 'waiting';
            
            document.getElementById('finalResults').classList.add('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('quizInfo').classList.add('hidden');
            document.getElementById('roomCode').textContent = '------';
        };

        window.closeRoom = function() {
            if (confirm('¬øEst√°s segura de que quieres cerrar la sala?')) {
                restartGame();
            }
        };

        // Manejo de archivos
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const quiz = JSON.parse(e.target.result);
                        loadQuiz(quiz);
                    } catch (error) {
                        alert('‚ùå Error al cargar el archivo JSON. Verifica el formato.');
                    }
                };
                reader.readAsText(file);
            }
        });

        // Drag and drop
        const fileUpload = document.getElementById('fileUpload');
        
        fileUpload.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        fileUpload.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        fileUpload.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                document.getElementById('fileInput').dispatchEvent(new Event('change'));
            }
        });

        function addStudent(name, avatar) {
            const studentsList = document.getElementById('studentsList');
            
            // Limpiar mensaje de espera
            if (Object.keys(students).length === 0) {
                studentsList.innerHTML = '';
            }
            
            students[name] = { 
                name, 
                avatar, 
                connected: true,
                currentAnswer: null,
                answerTime: 0,
                totalScore: 0
            };
            
            const studentItem = document.createElement('div');
            studentItem.className = 'student-item';
            studentItem.innerHTML = `
                <div class="student-avatar">${avatar}</div>
                <div class="student-name">${name}</div>
                <div class="student-status"></div>
            `;
            
            studentsList.appendChild(studentItem);
            document.getElementById('studentCount').textContent = Object.keys(students).length;
            
            // Mostrar controles de juego si hay estudiantes
            if (Object.keys(students).length > 0 && currentQuiz) {
                document.getElementById('gameControls').classList.remove('hidden');
            }
            
            console.log(`Estudiante ${name} se conect√≥ a la sala ${roomCode}`);
        }

        // Funci√≥n para simular conexi√≥n de estudiante (para pruebas)
        window.simulateStudentConnection = function() {
            const testName = prompt('Nombre del estudiante de prueba:');
            if (testName) {
                const avatar = testName.charAt(0).toUpperCase();
                addStudent(testName, avatar);
            }
        };

        // Agregar bot√≥n de prueba en modo desarrollo
        console.log('üí° Para probar conexiones: simulateStudentConnection()');
        console.log(`üìã C√≥digo de sala actual: ${roomCode || 'No generado a√∫n'}`);
    </script>
    
    <!-- Bot√≥n oculto para pruebas (solo visible en consola) -->
    <div style="position: fixed; bottom: 10px; right: 10px; z-index: 1000;">
        <button onclick="simulateStudentConnection()" style="background: #666; color: white; border: none; padding: 8px; border-radius: 5px; font-size: 12px; display: none;" id="testBtn">
            + Estudiante Test
        </button>
    </div>

    <script>
        // Mostrar bot√≥n de prueba solo cuando hay sala abierta
        window.addEventListener('load', function() {
            const showTestButton = () => {
                const btn = document.getElementById('testBtn');
                if (roomCode && btn) {
                    btn.style.display = 'block';
                }
            };
            
            // Revisar cada segundo si hay c√≥digo de sala
            setInterval(() => {
                if (roomCode) showTestButton();
            }, 1000);
        });
    </script>
</body>
</html>